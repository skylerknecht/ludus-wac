---
- name: Install AD DS + DNS
  ansible.windows.win_feature:
    name:
      - AD-Domain-Services
      - DNS
    include_management_tools: true
    state: present

- name: Promote to new forest if not already a DC
  ansible.windows.win_shell: |
    $domain="{{ wac_domain_fqdn }}"
    $sm = ConvertTo-SecureString "{{ wac_safe_mode_password }}" -AsPlainText -Force

    $isDC = $false
    try {
      (Get-WmiObject -Class Win32_ComputerSystem).DomainRole | Out-Null
      $role = (Get-WmiObject -Class Win32_ComputerSystem).DomainRole
      # 4/5 = domain controller roles
      if ($role -ge 4) { $isDC = $true }
    } catch {}

    if (-not $isDC) {
      Import-Module ADDSDeployment
      Install-ADDSForest -DomainName $domain -SafeModeAdministratorPassword $sm -InstallDNS -Force
    }
  register: dc_promo

- name: Reboot after promotion if required
  ansible.windows.win_reboot:
    reboot_timeout: 2400
  when: dc_promo is changed

- name: Wait for ADWS (Active Directory Web Services)
  ansible.windows.win_shell: |
    for ($i=0; $i -lt 120; $i++) {
      $svc = Get-Service ADWS -ErrorAction SilentlyContinue
      if ($svc -and $svc.Status -eq "Running") { exit 0 }
      Start-Sleep -Seconds 10
    }
    throw "ADWS not running yet"